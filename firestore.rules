rules_version = '2';
service cloud.firestore{
    match /databases/{database}/documents{
        match /{document=**}{

            //for collection group queries
            match /posts/{postId}{
                allow read;
            }

            match /users/{userId}{
                allow read;
                allow create: if isValidUser(userId);
            }

            match /usernames/{username}{
                allow read;
                allow create: if isValidUsername(username);
            }

            match /users/{userId}/posts/{postId}{
                allow read;
                allow create: if canCreatePost(userId);
                allow update: if canUpdatePost(userId) || canIncrementHearts(userId,postId);
                allow delete: if request.auth.uid == userId;
            }

            match /users/{userId}/posts/{postId}/hearts/{heartId}{
                allow read;
                allow write: if request.auth.uid == heartId;
            }

            function isValidUser(userId){
                let isOwner = request.auth.uid ==userId;
                //resource -requested document , data -pola w tym dokumencie
                let username = request.resource.data.username;
                // sprawdz czy dokument istnieje zakladajac ze zadanie sie powiedzie
                let createdValidUsername = existsAfter(/databases/$(database)/documents/usernames/$(username));
                return isOwenr && createdValidUsername;
            }

            function isValidUsername(username){
                let isOwner = request.auth.uid == request.resource.data.uid;
                let isValidLength = username.size() >=3 && username.size()<=15;
                //getAfter pobiera dokument gdy hipotetycznie zapisa partii danych sie zakonczyl - sprawdzamy czy username dla konkretnego uid bedzie taki sam jak podany
                let isValidUserDoc = getAfter(/databases/$(database)/documents/users/$(request.auth.uid)).data.username == username;

                return isOwner && isValidLength && isValidUserDoc;
            }

        }
    }
}